# 文字参照

ここまで、様々なマークを学びました。
時には、マークを意味する文字をそのままテキストとして書きたいこともあります。ここでは、そのような際に利用できる文字参照の仕組みについて説明します。


## 文字参照の概要

時には、マークをマークとして解釈されては困ることもあります。以下はHTMLのタグの書き方を説明している文章です。

```plaintext
見出しの先頭に<h1>を、末尾に</h1>を入れてください
```

これをHTMLとして表現するにはどうすれば良いでしょうか。単純に`p`要素としてマークアップしてみると、以下のようになりそうです。

```html
<p>見出しの先頭に<h1>を、末尾に</h1>を入れてください</p>
```

これをブラウザで表示させると、以下のようになります。

```plaintext
見出しの先頭に
を、末尾に
を入れてください
```

`<h1>`などの文字が表示されず、意図とは異なる挙動になっています。これは、`<`の文字がタグを開始するマークとして認識され、`<h1>`がテキストではなくタグとみなされたためです。

このように、マークに使用する文字をテキストとして書きたい場合には、「文字参照」(character reference) という仕組みを利用することができます。文字参照は、文字を直接書くのではなく、文字を参照するための記述をすることで、間接的に文字を参照する仕組みです。

先の例は、以下のように書くことができます。

```html
<p>見出しの先頭に&lt;h1>を、末尾に&gt;/h1>を入れてください</p>
```

`<`という文字のかわりに、`&lt;`という文字列を書きました。これが文字参照です。`&lt;`と書くと、`<`を書いたのと同じ意味になりますが、マークとして解釈されることはありせん。このように、特別な意味を持つ文字を書きたいとき、特別な書き方をしてその意味を失わせることを「エスケープ」(escape)と言います。

文字参照の方法には大きく2種類あり、ひとつが「名前付き文字参照」(named character reference)、もうひとつが「数値文字参照」(numeric character reference)です。


## 名前付き文字参照

名前付き文字参照は、文字を名前で参照する方法です。先に紹介した`&lt;`は名前付き文字参照の例で、`lt;`の部分が名前です。

名前付き文字参照には、比較的覚えやすい名前が使われています。たとえば`lt`は"less than"の略で、小なり記号`<`に対応する、といった具合です。名前がついているので思い出して使いやすい一方で、全ての文字に対応しているわけではないという弱点もあります。よく使われる名前については後述します。

HTMLでは、名前付き文字参照がのべ2230種類[^1:同じ文字に別名がついているもの、セミコロンの有無が両方定義されているものも含んだ延べ数]ほど定義されています。この一覧は以下のURLで見ることができます。

<https://html.spec.whatwg.org/multipage/named-characters.html>

### 大文字小文字の区別

名前付き文字参照では、大文字と小文字を区別します。時には、大文字と小文字で別の文字を参照する場合もあります。たとえば、`&aacute;`はアクセント記号付きの小文字のaを表しますが、`&Aacute;`はアクセント付き大文字のAを現わします。

なお、よく使われるAMP LT QUOT GTは大文字の参照も定義されているので、大文字で書くことも可能です。ただし、Ampなどは定義されていないので、大文字小文字を混ぜてしまうとうまく参照できません。

### 末尾のセミコロンを忘れた場合

名前付き参照は、原則として`&`で始まり`;`で終わります。末尾にはセミコロンが必要です。
ただし、一部の名前については、セミコロンがなくても文字参照として解釈されることがあります。先に紹介した名前付き文字参照の一覧には、末尾にセミコロンがあるものだけでなく、セミコロンがないものも登録されていることがあります。

たとえば、`amp;`については、セミコロンがない`amp`も登録されており、同じ文字を指すように定義されています。しかし、すべての名前にセミコロンがないバージョンが存在するわけではありません。`Abreve;`は登録されていますが、セミコロンのない`Abreve`は登録されていません。

セミコロンのないものが登録されている場合、末尾のセミコロンを書き忘れても、エラー処理 (missing-semicolon-after-character-reference parse error) の結果として文字参照が有効になることがあります。ただし、属性値の中ではエラー処理の結果が異なり、セミコロンのない文字参照は無効となって、書いたままの文字として解釈されます。

|書いた内容|処理結果|備考|
|----|----|
|href="&amp;"|href="&"||
|<p>&amp;</p>|<p>&</p>||
|href="&amp"|href="&amp"|エラー処理の結果|
|<p>&amp</p>|<p>&</p>|エラー処理の結果|

エラー処理のルールが複雑になっているのは、URLに使用される`&`のエスケープ忘れがよくあるためです。URLのクエリ文字列の区切りに`&`を使っている場合、`href`属性にそのURLを書く際にはエスケープが必要です。

たとえば、`/foo?type=square&degree=30`というURLがあったとします。これを`p`要素の中にテキストとして書く場合、以下のように`&`を`&amp;`にエスケープしなければなりません。

```html
<p>/foo?type=square&amp;degree=30</p>
```

エスケープを忘れて以下のように書くとどうなるでしょうか。

```html
<p>/foo?type=square&degree=30</p>
```

実は、`&deg;`という名前付き文字参照が定義されており、度数をあらわす`°`という文字に対応しているためです。セミコロンが書かれていないのでエラーになりますが、セミコロンなしの`&deg`も定義されているため、エラー処理の結果として文字参照が展開されて対応する文字に置き換えられます。結果として、表示は以下のようになります。

```plaintext
/foo?type=square°ree=30
```

では、このURLをhref属性に書く場合はどうなるでしょうか。実はこの場合も、以下のように`&`を`&amp;`にエスケープしなければなりません。

```html
<a href="/foo?type=square&amp;degree=30">
```

このとき、エスケープを忘れて以下のように書くとどうなるでしょうか。

```html
<a href="/foo?type=square&degree=30">
```

さきほどの`p`要素の例を考えると、`&deg`が`°`に置き換えられてもおかしくなさそうです。

```html
<a href="/foo?type=square°ree=30">
```

しかし、実際にはこうはならず、`&degree`の部分は`&degree`のままとなります。

ここで示した例のように、属性値のURLに含まれる`&`をエスケープし忘れると、予期せぬ動作になります。そして、エスケープを忘れる人が後を絶たたないため、現在のHTMLでは、属性値の中のセミコロンなしの文字参照は置換しないことにしているのです。

とはいえ、いずれにしても、これはエラー処理の結果にすぎません。セミコロンを書かないのは正しい書き方ではありませんし、トラブルのもとにもなりますので、省略しないようにしましょう。


### 数値文字参照

数値文字参照は、名前の代わりに数値によって文字を指定する方法です。HTMLでは、Unicodeで定義されている文字をほとんど全て使用することがてきます。Unicodeの文字には、全ての文字に一つずつ「コードポイント」(code point)と呼ばれる番号が振られており、番号で文字を特定することができます。数値文字参照では、このコードポイントを指定することで文字を参照します。

数値の表記の仕方は2つあり、それぞれ「十進数値文字参照」(Decimal numeric character reference)、「十六進数値文字参照」(Hexadecimal numeric character reference)と呼ばれます。

名前付き文字参照との違いは、`&`の後に`#`が入ることです。十進数値文字参照では、その後にそのまま十進数のコードポイントを書きます。一般に、Unicodeのコードポイントは`U+003C`のように十六進数で表記されますので、十進数値文字参照で書くときには十進数に直す必要があります。

十六進数表記をそのまま書きたい場合は、十六進数値文字参照を使用します。`&#`のあとに`x`もしくは`X`を書き、その後に、十六進数表記でコードポイントを指定します。大文字小文字は問いません。

先ほど、`<`を名前付き文字参照で`&lt;`と書く例をあげました。`<`のコードポイントは`U+003C`ですので、十進数値文字参照、十六進数値文字参照で書くと以下のようになります。

```html
&#60;
&#x3c;
```

十六進数値文字参照は大文字で書いてもかまいませんので、以下のように書くこともできます。

```html
&#X3C;
```

## よく使われる名前付き文字参照

文字参照が最もよく利用されるのは、マークに使われる文字をエスケープして意味を失わせる場合です。エスケープ目的でよく利用される名前付き文字参照は、以下の3種類です。

- `&lt;`→`<`
- `&quot;`→`"`
- `&amp;`→`&`

`<`は先に説明した通り、タグやコメントの開始として解釈されるため、それを防ぐためにエスケープします。
なお、対になる`>`については、実はほとんどのケースでエスケープ不要です。エスケープが必要になるのは、引用符で括られていない属性値の中で出現する時くらいです。しかし運用上は、`<`だけをエスケープするとすわりが悪いからなのか、一緒にエスケープされているケースが多いようです。

`"`は属性値の引用符として使われるため、`"`で括られた属性値の中ではエスケープする必要があります。

```html
<img alt="he said &quot;wait!&quot;">
```

`&`は、今まさに紹介している文字参照に使用する文字です。以下のようなテキストがあったとします。

```plaintext
引用符で括られた属性値の中で"を書きたいときは、&quot;と書きましょう。
```

これをそのままHTMLに書くと以下のようになります。

```html
<p>引用符で括られた属性値の中で"を書きたいときは、&quot;と書きましょう。</p>
```

このとき、`&quot;`と書かれている部分は文字参照とみなされて`"`に展開されます。結果として以下のような表示になってしまいます。

```plaintext
引用符で括られた属性値の中で"を書きたいときは、"と書きましょう。
```

これを防ぐためには、`&`の部分を文字参照で表現してエスケープすれば良いのです。以下のようになります。

```html
<p>引用符で括られた属性値の中で"を書きたいときは、&amp;quot;と書きましょう。</p>
```

なお、属性値は`'`でくくることもできます。その場合は、属性値の中の`'`を`&apos;`としてエスケープすることができます。ただし、属性値を`'`でくくるスタイル自体が稀であるから、このエスケープはあまり使われていません。また、`&apos;`という文字参照は、かつてのHTML4には存在しなかったため、後述する数値文字参照を使って`&#39;`とすることもあります。


### 入力しにくい文字に使う文字参照

前述したエスケープが必要なケースをのぞき、文字参照を利用することが必須になるケースはありません[^1:時には歴史的な理由からUTF-8を利用せず、特殊な文字符号化方式を採用していることもあるかもしれません。そのような場合、文字符号化方式によっては表現することができない文字が存在することがあります。その場合でも、数値文字参照を使えば文字を表現することができます]。通常、HTMLファイルはUTF-8で符号化しますので、Unicodeのすべての文字をそのまま書くことができます。

しかし、表現はできても入力が難しいということもあるかもしません。たとえば、コピーライトマーク `©` は比較的よく利用されますが、入力方式によっては簡単には入力できないかもしれません。多くの場合、このような文字には文字参照が定義されています。
比較的よく使われるのは、以下のようなものです。

- `&copy;`
- `&reg;`
- `&nbsp;`
- `&endash;`

とはいえ基本的には、文字参照を使用するよりもそのまま書いてしまったほうが良いでしょう。

## コラム: 実体参照という呼び名

以前のHTMLでは、名前付き文字参照のことを「文字実体参照」(character entity reference)と呼んでいました。これは、SGMLの「実体参照」(entity reference)の仕組みを利用して文字を参照するものです。

実体参照とは、主に外部で定義した「実体」(entity)を文書などから参照するものです。以下はXMLで実体参照を利用している例です。

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE foo [
    <!ENTITY greeting "こんにちは">
]>
<foo>
    <hello>&greeting;</hello>
</foo>
```

この例では、まず文書型定義の中で「こんにちは」という実体にgreetingという名前をつけています。そして、文書の中で`&greeting;`のように書いて実体を参照しています。この実体参照は「こんにちは」という実体に置き換えられます。

実体は外部ファイルとして定義することもできます。

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE foo [
    <!ENTITY external-file SYSTEM "external.xml">
]>
<foo>
    <ext>&external-file;</ext>
</foo>
```

外部ファイル`external.xml`を実体として、`external-file`という名前を付けています。このとき、外部ファイルの内容を「外部実体」(external entity)と呼びます。文書の側に`&external-file;`と書くと、この外部実体を参照し、ファイルの内容がここに展開されます。

「実体」というのは参照される側で、参照する側は「実体参照」であることに注意してください。実体参照を「実体」「エンティティ」などと呼んでしまう混乱がしばしば見られました。実体を定義したことがあればこのような混乱は起きないはずですが、HTMLを書く際には実体参照のほうだけを書くため、混乱が起きてしまうのでしょう。

そして、現在のHTMLでは「実体参照」という呼び方も使わなくなっています。現在のHTMLはSGMLではないため、SGMLの機能である「実体参照」の呼び名を使う必要性がないということなのでしょう。




