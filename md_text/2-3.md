# URL

HTMLの属性には、属性値としてURLを指定するものが多数あります。ここでは、URLの構文について説明します。

## URLの基本構文

属性の中には、値としてURLを指定するものがあります。代表例は`a`要素の`href`属性です。

```html
<a href="https://www.w3.org/">W3C</a>
```

URLは、リソースの場所を特定するための汎用的な識別子です。URLの詳細はURL Standard[^1]で定義されています。

[^1]: https://url.spec.whatwg.org/

URLでまず連想されるのは、`https`で始まるものでしょう。

```text
https://example.com/
```

上記はシンプルな例ですが、もう少し複雑な例もあります。

```text
https://example.com:443/foo/bar.php?q=xxx#result
```

### URLスキーム

先頭の`https`の部分は「URLスキーム」(URL Scheme)と呼ばれ、このURLの種類を表します。IANAに登録されているスキームの一覧はUniform Resource Identifier (URI) Schemes[^2]で確認することができます。ウェブでは`https`の他に、以下のものがよく使われます。

[^2]: https://www.iana.org/assignments/uri-schemes/uri-schemes.xhtml

- http
- ftp
- file
- wss
- mailto

スキームは多くの場合、リソースの取得方法となるプロトコルを表しています。ただし、常にスキームが通信プロトコルを表すとは限りません。たとえば`mailto`で実際に使われる通信プロトコルはSMTPです。`file`にいたっては通信が発生しません。また、IANAには登録されていませんが、`javascript`というスキームのURLが使われることもあり、こちらも通信は発生しません。

スキームの後は、1文字の`:`で区切ります[^1]。その後に続く内容はスキームによって異なりますが、ここでは`https`（`http`も同様）の場合を紹介します。

[^1]: `:`の前までをスキームと呼ぶこともあれば、スキームであることを明確にするために、`:`まで含めて記述することもあります。本書では、URL Standardに従って、`:`を含めないものをスキームと呼びます。

### ホスト

`https`の場合、`https:`の直後に`//`を書き、その後に続いて「ホスト」(host)が書かれます。ホストは、ドメイン名かIPアドレスのいずれかです。多くの場合はドメイン名が使用されます。

```text
https://example.net
```

ドメイン名はFQDN (Fully Qualified Domain Name, 完全修飾ドメイン名)でなくても構いません。以下のように`localhost`を指定してローカルホストを参照することもあります。

```text
http://localhost
```

#### ポート

ホストの後ろには「ポート」(port)の情報が来ることがあります。ポートを書く場合は`:`で区切って、0〜65535の整数（ポート番号）を記述します。

```text
http://localhost:8080
```

ポートは省略することができます。省略する場合はデフォルトのポート番号が使用されます。デフォルトのポート番号は、`http`は80、`https`は443です。IANAに登録されているポート番号の一覧は、Service Name and Transport Protocol Port Number Registry[^3]で見ることができます。

[^3]: https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml

### パス

ホストの後ろ (ボートが記述されている場合はポートの後ろ) には、「パス」(path)の記述が続きます。パスは、そのホスト内でリソースを特定するための記述です。

パスは`/`で始まります。さらに複数の`/`で区切って階層化することもできます。たとえば以下のようになります。

```text
https://example.net/foo/bar/baz.html
```

"/"で区切られたそれぞれの部分を「URLパスセグメント」(URL path segment)と呼びます。URL StandardではURL-path-segment stringとして定義されています。上記の例では`foo`と`bar`と`baz.html`がURLパスセグメントにあたります。

特殊なURLパスセグメントとして、`.`（「単一ドットパスセグメント」(single-dot path segment)）と`..`（「二重ドットパスセグメント」(double-dot path segment)）があります。`.` は現在と同じ階層、`..` は親階層を表します。

`.`は現在の階層を表すので、`.`が出現する前のパスを指すことになります。つまり、以下はすべて同じリソースを指します。

```text
/foo/
/foo/./
/foo/./././././././
```

`.`が間に挟まっても同じです。以下は全て同じリソースを指します。

```text
/foo/bar/
/foo/./bar/
/foo/./././bar/././././
```

`..`の場合は親階層を指します。以下は全て同じリソースを指します。

```text
/foo/
/foo/bar/../
/bar/../foo/
/bar/../baz/../foo/
```

こう見ると冗長なだけのように見えますが、この記述方法は後述するパス相対URLで活躍します。

### クエリ

パスの後ろには、「クエリ」(query) と呼ばれる文字列がつくことがあります。クエリをつける場合は、`?`の1文字で区切ります。

クエリというのは「問い合わせ」というような意味です。GETメソッドと呼ばれるフォームを送信すると、フォームに入力したデータがURLの末尾につけられ、URLを通じてサーバに送信されます。これがクエリです。つまり、サーバに対する問い合わせに使用するところからこの名前が来ています。現在では、クエリはフォーム送信の時だけでなく、アクセス元をトラッキングする目的や、キャッシュを更新させる目的で使用されることもあります。

### フラグメント

URLの末尾には、「フラグメント」(fragment)と呼ばれる文字列がつくことがあります。フラグメントをつける場合は、`#`一文字で区切ります。
フラグメントとは「断片」という意味です。URLは特定のリソースを指しますが、そのリソースの中のある特定の部分を指したい時にフラグメントを使用します。HTMLの場合は、`id`属性で指定された名前をそのままフラグメントとして指定することで、HTML文書の特定の箇所を指すことができます。

フラグメントは「ハッシュ」(hash)と呼ばれることもあります。これは、区切りに使用する文字`#` (U+0023, "NUMBER SIGN") が、別名でハッシュとも呼ばれるためです。たとえば、JavaScriptでは`location.hash`でフラグメントの値を参照することができます。

## 相対URL

URLは前述したように、スキームから始まる表記を連想することが多いと思います。スキームから始まる完全な形式のURLを「絶対URL」(absolute URL)と呼びます。URL Standardではabsolute-URL stringとして定義されます。

一方、「相対URL」(relative URL)と呼ばれるURLの表記方法もあります。URL Standardではrelative-URL stringとして定義されます。これは、現在の場所からの相対位置を示します。HTML文書を閲覧している場合は、通常そのHTML文書自体のURLからの相対参照と解釈します。[^4]

[^4]: `base`要素でURLが指定される場合は、そのURLを「基準URL」(base URL)として、そこからの相対参照と解釈します。

相対URLは以下のようなものがあります。

- 「スキーム相対URL」(scheme relative URL)
- 「パス絶対URL」(path absolute URL)
- 「パス相対URL」(path relative URL)

### スキーム相対URL

スキーム相対URLは、絶対URLからURLスキームと`:`を取り除いたものです。先頭が`//`で始まり、ホスト名が続きます。以下のような形になります。

```text
//example.com/foo/bar.html
```

スキーム相対URLを使用した場合、スキームは基準URLと同じものとみなされます。たとえば、上記は、基準URLのスキームが`https`ならば`https://example.com/foo/bar.html`に、`http`ならば`http://example.com/foo/bar.html`と同じになります。

URL Standardではscheme-relative-URL stringとして定義されます。

### パス絶対URL

パス絶対URLは、スキーム相対URLからホスト名部分を取り除いたものです。先頭が`/`で始まり、パスの記述が続きます。

```text
/foo/bar.html
```

パス絶対URLを使用した場合、スキームとホスト名は基準URLと同じものとみなされます。

名前に“絶対”とありますが、これはURL全体が絶対という意味ではなく、パス部分が絶対パスで書かれているという意味です。パス絶対URLは絶対URLではなく、相対URLの一種です。

URL Standardではpath-absolute-URL stringとして定義されます。

### パス相対URL

パス相対URLは、先頭が`/`で始まらないパスの記述です。

```text
foo/bar.html
```

パス相対URLを使用した場合、スキームとホスト名は基準URLと同じとみなされ、基準URLからの相対パスとして解釈します。

パス相対URLでは、URLパスセグメントに`.`や`..`を使う記述が生きてきます。たとえば、基本URLのパスが`/foo/bar/baz.html`であるとき、以下のようになります。

- `./` → `/foo/bar/`
- `../` → `/foo/`
- `../../` → `/`
- `./baz2.html` → `/foo/bar/baz2.html`
- `../baz2.html` → `/foo/baz2.html`

URL Standardではpath-relative-URL stringとして定義されます。

## URLに使える文字

URLパスセグメントやクエリ、フラグメントに使える文字は、「URLコードポイント」(URL code points)として決められています。具体的には、次の文字になります。

- ASCII英数字
- 記号類: `!`, `$`, `&`, `'`, `(`, `)`, `*` , `+`, `,`, `-`, `.` `/`, `:`, `;`, `=`, `?`, `@`, `_`, `~`
- U+00A0〜U+10FFFDのUnicode文字。ただし、「サロゲート」(surrogates)と「非文字」(noncharacters)を除く

括弧`(`および`)`がURLに使用できる文字であることに注意してください。メール等で文中のURLがリンクになるような仕組みがありますが、`(https://example.com)`と書くと、末尾の`)`がURLの一部とみなされることがあります。不等号（`<`および`>`）はURLに使用できないため、URLを囲みたい場合は不等号を使うと誤認識を防げます。

URLに使用できない文字や、特別な意味に解釈される文字は、「パーセントエンコードバイト」(Percent-encoded bytes)[^5]として記述することができます。

[^5]: この記述方法は、「パーセントエンコード」、「URLエンコード」、「パーセントエンコーディング」などと呼ばれることもあります。

パーセントエンコードバイトの記述は、`%`に続いて2桁の16進数で文字コードを表記します。たとえば、`<`は`%3C`、`>`は`%3E`となります。`%`文字そのものを書きたい場合は、`%25`と記述します。

非ASCII文字をパーセントエンコードする際には、原則としてUTF-8で符号化して扱います。たとえば、「日本語」という文字列の場合、UTF-8で符号化すると以下のようになります。

-「日」(U+65E5) → E6 97 A5
-「本」(U+672C) → E6 9C AC
-「語」(U+8A9E) → E8 AA 9E

これをパーセントエンコードすると以下のようになります。

```text
%E6%97%A5%E6%9C%AC%E8%AA%9E
```

## パスワード付きURL

URLのホストの前に認証情報がつく形式が存在します。IDとパスワードを`:`でつなぎ、後ろを`@`で区切り、その後にホストを続けます。具体的には以下のような形になります。

```text
https://user:password@example.com/
```

URLに認証情報を含めることはセキュリティ上の問題に繋がりやすいため、このようなURLはURL Standardでは認められていません。しかし、ブラウザは互換性の理由から、このような形式のURLを受け入れて解釈する場合があります。

プログラムでURLをチェックする場合には、ホストの前に認証情報がつくこともあるということを念頭に置いておきましょう。

## コラム: URLという言葉の歴史

URLという言葉は多くの読者に馴染みがあると思いますが、この言葉は混乱を乗り越えてきた歴史があります。

ティム・バーナーズ＝リーが最初に提唱したURLは、"Universal Resource Locator"の略称でした。後に、"Uniform Resource Locator"の略称とされ、最初期にはRFC 1630、次にRFC 1738として標準化されました。さらにその後、リソースを場所ではなく名前で特定する「URN」(Uniform Resource Name)という方式が提唱されました、URNの構文は、RFC 2141で規定されています。URLとURNをあわせた一般的な概念として、「URI」(Uniform Resource Identifier)と呼ぶようになりました。URIは初めにRFC 2396、後にRFC 3986として標準化されました。古いHTML4の仕様では“URI”という表記が使われています。また、URIの国際化表記である「IRI」(Internationalized Resource Identifier)がRFC 3987として標準化されています。

こうして、“URL”、“URI”、“IRI”という3種類の表記が生まれました。“URL”は“URI”の一種であり、“URI”は“IRI”の一種です。ですので、“URL”という言葉が使える文脈では、3つのどれを使っても意味が通じます。こうなると逆に使い分けが難しくなってきます。そして世間一般では、“URI”や“IRI”はそこまで知られておらず、“URL”という言葉が使われ続けていました。

また、様々な技術仕様で技術用語としてURIやIRIが用いられていましたが、各技術仕様で規定しているURIやIRIがそれぞれ微妙に異なることが知られています。URIやIRIは、技術的な内容も混乱していたという状況もありました。

いずれにせよ、単語としてURLが世間的によく使われているという状況も踏まえて、HTML5では改めて“URL”という名前で統合することにしました。ここで言うURLは、技術的にはRFC 1738のURLと同じものではありません。RFC 3986のURIやRFC 3987のIRIだけでなく、URLに関連する技術仕様も含めて、統合・整理したものとなっています。HTML5でURLが規定されていましたが、後にURL Standardとして独立したWHATWG標準になりました。

つまるところ、名称としてはURL→URI→IRIと変遷した上で、もう一度“URL”に戻ってきたということになります。
このような背景で成立したため、現在のWHATWG URLは"Uniform Resource Locator"の略でなく、単にURLとして定義されています。

