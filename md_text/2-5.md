# HTMLで扱える文字

Webブラウザは、画像、映像などさまざまなデータを扱うことができますが、基本となるのはやはりテキストです。ここでは、テキストをデジタルデータとして扱う際の表現方法について説明します。

## テキストデータのデジタル表現

文字だけで構成されたデータを「テキストデータ」と呼びます。先に説明したように、HTMLは、マークアップを含んだテキストデータです。

コンビュータは、アナログ情報をそのまま扱うことができません。コンピュータがテキストを扱う際には、デジタルデータにして処理する必要があります。具体的には、文字を特定のビット列に対応させることで表現します。

テキストは別のコンピュータでも読み取れる必要がありますから、この対応のルールは統一しておく必要があります。このために、文字をビット列で表現する際の共通規格が必要になります。

1963年にアメリカで作られたのが、ASCII (American Standard Code for Information Interchange) という規格です。アルファベットの大文字と小文字、数字、基本的な記号類などが定義されており、これらは今では「ASCII文字」と呼ばれています。

## 文字コード

ASCIIでは、128種類の文字に対して、7ビットのビット列を割り当てるルールを決めました。たとえば、スペース、0,9,A,Z,a,zに対して、それぞれ以下のようなビット列を割り当てています。

- (スペース) → 0100000 (32, 0x20)
- 0 → 0110000 (48, 0x30)
- 9 → 0111001 (57, 0x39)
- A → 1000001 (65, 0x41)
- Z → 1011010 (90, 0x5a)
- a → 1100001 (97, 0x67)
- z → 1111010 (122, 0x7a)

カッコ内は、このビット列を十進数表記、十六進数表記で書いたものです。十進数や十六進数の表記に対応させられることから、これは、文字に番号を振っているとも言えます。

このようにして文字に割り当てられた番号を「文字コード」(Character Code) と呼びます。「ASCIIでは、大文字Aの文字コードは0x41である」という言い方をします。

また、このような文字コードの割り当てルールの体系全体を指して「文字コード」と呼ぶこともあります。

### 余談・ASCII文字の並び

ASCIIの文字コード体系では、制御コード、記号、数字、記号、大文字、記号、小文字、記号、DEL、という順に定義されています。数字、大文字、小文字が連続せずに間に記号が挟まっているのは、一見奇妙に見えるかもしれません。しかしビット列を見ると、A や a がキリの良い位置にあることがわかります。

- A → 1000001 (65, 0x41)
- a → 1100001 (97, 0x67)

こうなっていることで、6ビット目 (先頭から数えると2ビット目) を反転するだけで大文字・小文字を切り替えられるというデータ処理上のメリットがあります。

## 符号化文字集合と文字符号化方式

ASCIIは7ビットで文字を表現していましたが、7ビットで表現できるパターンは128通りしかありません。英数字のみを扱う場合はこれでも問題ありませんが、英語圏以外ではもっと多くの文字を扱う必要があります。そこで、ASCIIを拡張する形で、さまざまな文字コードの規格が作られました。

たとえば、ASCIIを8ビットに拡張して文字を追加したものが ISO-8859-1 (ISO/IEC 8859-1, Latin-1とも呼ばれる) という規格です。ISO-8859-1では、ASCIIにはなかった通貨記号 (£、¥など) や、フランス語などで使われるアクセント付き文字 (àなど)、ドイツ語などで使われるウムラウト付き文字 (äなど) などが追加され、英語以外のさまざまな言語に対応できるようになっています。

ASCIIやISO-8859-1はシンプルな文字コード体系で、文字につけた番号をそのままビット列としているだけでした。しかし、より多くの文字を扱う必要が出てくると、文字につけた番号と、データ化する際のビット列が異なるケースも出てきます。

このとき、番号をつけた文字のリストのことを「符号化文字集合 (Coded Character Set)」と呼び、文字の番号を「コードポイント」(code point) と呼びます。日本産業規格(JIS規格)では「符号位置」と呼んでいます。

そして、文字を実際にビット列で表現する方法のことを「文字符号化方式 (Chatacter Encoding Scheme)」と言います。単に「エンコーディング」と呼ぶこともあります。

たとえば、現在よく使われているUnicodeの符号化文字集合では、ひらがなの「あ」には十進数で12354、十六進数で0x3042というコードポイントが割り当てられています。Unicodeではこれを「Unicodeスカラ値」(unicode scalar value)と呼び、「U+」に続けて十六進数で表記します。「あ」の場合は「U+3032」となります。

Unicodeスカラ値が U+3032 である「あ」という文字をUTF-16という文字符号化方式で表現すると、0x30 0x42 というデータになります。これはコードポイントをほぼそのままビット列にしただけですが、符号化方式によってはそうならない場合があります。UTF-8という文字符号化方式を使用した場合、U+3032 は 0xE3 0x81 0x82 というデータで表現されることになります。

このように、文字を最終的にバイナリデータとして表現することを「符号化」(encode, encoding) と呼びます。「『あ』という文字をUTF-8で符号化する」というような言い方をします。

## HTMLで扱う符号化文字集合

HTMLの歴史を振り返ると、初期のHTML (HTML2.0〜HTML3.2) はISO-8859-1 しか扱えませんでした。その後、HTML2.x (HTMLi18n) でHTMLの国際化の仕様が作られ、HTML4ではISO/IEC 10646の文字全てが扱える仕様になりました。これは、Unicodeの文字が全て扱えるという意味だと考えて差し支えありません。この状況は現在も引き継がれています。

ただし、文字が扱えるということと、文字が確実に表示できることとはイコールではありません。HTMLの仕様としては扱えても、端末の側にその文字を表示できるフォントがあるかどうかはまた別の問題になります。

## HTMLで扱う文字符号化方式

現在のHTMLで扱う文字符号化方式は「Encoding」という文書にまとめられています。

Encoding Living Standard 
<https://encoding.spec.whatwg.org/>

この文書では、冒頭で端的に「今後作成するHTML文書ではUTF-8を使うべき」と述べています。特に強い理由がない限り、HTML文書はUTF-8で符号化するべきです。

### UTF-8以外の文字符号化方式

とはいえ実際には、UTF-8以外で符号化された古い文書を扱う必要もあります。そのため、仕様ではいくつかの文字符号化方式に対応することが求められています。対応が必須とされているものは以下の通りです。

UTF-8, ISO-8859-2, ISO-8859-7, ISO-8859-8, windows-874, windows-1250, windows-1251, windows-1252, windows-1254, windows-1255, windows-1256, windows-1257, windows-1258, gb18030, Big5, ISO-2022-JP, Shift_JIS, EUC-KR, UTF-16BE, UTF-16LE

また、"x-user-defined" という指定にも対応できる必要がありますが、これはwindows-1252とみなされます。なお、これは最低限であり、これ以外の文字符号化方式を扱えるようになっていても構いません。

このリストの文字符号化方式の中には、Unicdoe以外の符号化文字集合を扱うものもあります。たとえば、Shift_JISは文字集合として「JIS X 0208」を扱いますが、これはUnicodeよりも収録されている文字が少なく、したがってShift_JISではUnicodeの文字すべてを表現することはできません。

ただし、文字参照の仕組みは文字符号化方式に依存しません。そのため、Shift_JISで符号化された文書であっても、文字参照を使うことでUnicodeの全ての文字を表現することができます。

## 文字符号化方式の判定

HTML文書を処理する際には、まず文字符号化方式の判定を行う必要があります。詳しくは[12.2.3.2 Determining the character encoding](https://html.spec.whatwg.org/multipage/parsing.html#determining-the-character-encoding) を参照してください。

大まかには、まず、以下のような判定で文字符号化方式が確定するかを試みます。

- ユーザーが文字符号化方式を指定しているなら、それを採用する (ユーザーが手動で文字符号化方式を切り替えたようなケース)
- HTTP応答ヘッダのContent-Typeで文字符号化方式が指定されていれば、それを採用するむ
- HTMLの解析を始める前に先頭1024bytesを読み、その中に`<meta charset>`がないか探し、あればそこで指定されたものを採用する

HTTP応答ヘッダで文字符号化方式が指定されていれば、ユーザエージェントの側はHTMLを読み始める前に文字符号化方式を確定することができます。HTTP応答ヘッダで指定できない場合 (ローカルファイルのHTML文書を扱う必要がある場合など) には `<meta charset>` の指定も有効です。この場合、ファイルの冒頭1024bytes以内に書いておくと、HTMLの解析前に見てもらえることが期待できます。

ここまで見て文字符号化方式が確定しない場合、ユーザエージェントは文字符号化方式を推測しつつHTMLの解析を始めることになります。

- 直前にいたページの文字符号化方式から推測する
- 出現するビット列から推測する
- HTMLの解析中に、推測と異なる指定の `<meta charset>` があれば、文字符号化方式を変更してHTMLの解析をやり直す

冒頭1024bytesで `<meta charset>` が見つからず、その後ろにあった場合には、HTMLの解析の途中で文字符号化方式が確定することがあります。この場合、HTMLの解析をやり直すことになるため、パフォーマンスが低下する可能性があります。

## 誤判定と文字化け、セキュリティ問題

テキストデータの文字符号化方式が正しく判定できないと、データを適切な文字に復元することができず、いわゆる「文字化け」を引き起こすことになります。

たとえば、「テキストです」という文字列をShift_JISで符号化した場合、Shift_JISとして解釈すれば「テキストです」となりますが、これをUTF-8として解釈した場合、たとえば以下のように表示されてしまいます。

![スクリーンショット:Shift_JISをUTF-8として解釈した際の文字化け](../img/sjis_as_uff-8.png)

また、誤判定はセキュリティ上の問題に繋がることもあります。ここでは詳細は述べませんが、Shift_JISと判定させて先行バイト埋め込みによって後ろの文字を消す方法、UTF-7と判定させて文字種チェックをすり抜ける方法などがあります。

このため、HTML文書を作成する際には、文字符号化方式を明確にして、誤判定が起きないようにすることが重要です。